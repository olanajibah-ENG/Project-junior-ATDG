{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content_title %}
    <h1>{{ title }}</h1>
    <div style="margin-top: 10px;">
        <button type="button" onclick="showAddForm()" class="button" style="background: #417690; color: white;">
            ‚ûï Add New Code File
        </button>
    </div>
{% endblock %}

{% block result_list %}
    {% if mongodb_error %}
        <div class="messagelist">
            <div class="error">{{ mongodb_error }}</div>
        </div>
    {% elif has_mongodb_data %}
        <form id="changelist-form" method="post">
            {% csrf_token %}
            <div class="results">
                <table id="result_list">
                    <thead>
                        <tr>
                            <th scope="col">
                                <input type="checkbox" id="action-toggle">
                            </th>
                            <th scope="col">File Name</th>
                            <th scope="col">Type</th>
                            <th scope="col">Status</th>
                            <th scope="col">Size</th>
                            <th scope="col">Created At</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in mongodb_data %}
                            <tr class="{% cycle 'row1' 'row2' %}">
                                <td>
                                    <input type="checkbox" name="_selected_action" value="{{ file.id }}" class="action-select">
                                </td>
                                <td>
                                    <strong>{{ file.filename|default:"Unknown" }}</strong>
                                </td>
                                <td>
                                    <span class="badge badge-{{ file.file_type|default:'unknown' }}">
                                        {{ file.file_type|default:"Unknown"|upper }}
                                    </span>
                                </td>
                                <td>
                                    {% if file.analysis_status == 'COMPLETED' %}
                                        <span style="color: green;">‚úÖ {{ file.analysis_status }}</span>
                                    {% elif file.analysis_status == 'FAILED' %}
                                        <span style="color: red;">‚ùå {{ file.analysis_status }}</span>
                                    {% elif file.analysis_status == 'IN_PROGRESS' %}
                                        <span style="color: orange;">‚è≥ {{ file.analysis_status }}</span>
                                    {% else %}
                                        <span style="color: gray;">‚è∏Ô∏è {{ file.analysis_status|default:"PENDING" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.content %}
                                        {% with size=file.content|length %}
                                            {{ size|filesizeformat }}
                                        {% endwith %}
                                    {% else %}
                                        0 bytes
                                    {% endif %}
                                </td>
                                <td>
                                    {{ file.created_at|default:"N/A" }}
                                </td>
                                <td>
                                    <a href="#" onclick="viewContent('{{ file.id }}', '{{ file.filename }}', '{{ file.content|escapejs }}')" 
                                       style="color: #417690; text-decoration: none; margin-right: 10px;">
                                        üëÅÔ∏è View
                                    </a>
                                    <a href="#" onclick="deleteItem('{{ file.id }}')" 
                                       style="color: #dc3545; text-decoration: none;">
                                        üóëÔ∏è Delete
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7">No code files found in MongoDB.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Actions dropdown -->
            <div class="actions">
                <label>Action: 
                    <select name="action" required>
                        <option value="" selected>---------</option>
                        <option value="delete_selected">Delete selected code files</option>
                    </select>
                </label>
                <button type="submit" class="button" title="Run the selected action" name="index" value="0">Go</button>
            </div>
        </form>

        <!-- Add Form Modal -->
        <div id="addModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 60%; max-height: 80%; overflow-y: auto;">
                <span onclick="closeAddModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2>Add New Code File</h2>
                <form method="post" id="addForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_new_item">
                    
                    <div style="margin-bottom: 15px;">
                        <label for="filename" style="display: block; margin-bottom: 5px; font-weight: bold;">File Name:</label>
                        <input type="text" id="filename" name="filename" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                               placeholder="e.g., main.py, script.js">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="file_type" style="display: block; margin-bottom: 5px; font-weight: bold;">File Type:</label>
                        <select id="file_type" name="file_type" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="c">C</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="sql">SQL</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="content" style="display: block; margin-bottom: 5px; font-weight: bold;">Code Content:</label>
                        <textarea id="content" name="content" required rows="15"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace;"
                                  placeholder="Paste your code here..."></textarea>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="closeAddModal()" 
                                style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" 
                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                            Add Code File
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Content Modal -->
        <div id="viewModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-height: 80%; overflow-y: auto;">
                <span onclick="closeViewModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2 id="viewTitle">Code File Content</h2>
                <pre id="viewContent" style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: monospace; border: 1px solid #dee2e6;"></pre>
            </div>
        </div>
    {% else %}
        <div class="messagelist">
            <div class="info">No MongoDB data available.</div>
        </div>
    {% endif %}
{% endblock %}

{% block pagination %}
    {% if has_mongodb_data and mongodb_data|length > 0 %}
        <p class="paginator">
            {{ mongodb_data|length }} code file{{ mongodb_data|length|pluralize }} (showing first 100)
        </p>
    {% endif %}
{% endblock %}

{% block search %}{% endblock %}
{% block date_hierarchy %}{% endblock %}
{% block filters %}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle all checkboxes
        const toggleAll = document.getElementById('action-toggle');
        const checkboxes = document.querySelectorAll('.action-select');
        
        if (toggleAll) {
            toggleAll.addEventListener('change', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }
    });

    function showAddForm() {
        document.getElementById('addModal').style.display = 'block';
    }

    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        document.getElementById('addForm').reset();
    }

    function viewContent(id, filename, content) {
        document.getElementById('viewTitle').textContent = 'Code File: ' + filename + ' (ID: ' + id.substring(0, 8) + '...)';
        document.getElementById('viewContent').textContent = content || 'No content available';
        document.getElementById('viewModal').style.display = 'block';
    }

    function closeViewModal() {
        document.getElementById('viewModal').style.display = 'none';
    }

    function deleteItem(id) {
        if (confirm('Are you sure you want to delete this code file?')) {
            // Create a form to submit the delete action
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = window.location.href;
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'delete_selected';
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = '_selected_action';
            idInput.value = id;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            form.appendChild(actionInput);
            form.appendChild(idInput);
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const addModal = document.getElementById('addModal');
        const viewModal = document.getElementById('viewModal');
        if (event.target == addModal) {
            addModal.style.display = 'none';
        }
        if (event.target == viewModal) {
            viewModal.style.display = 'none';
        }
    }
    </script>
{% endblock %}