{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
<style>
    /* Theme Variables */
    :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --header-bg: #f8f9fa;
        --border-color: #dee2e6;
        --table-bg: #ffffff;
        --row-hover: #f5f5f5;
        --modal-bg: #ffffff;
        --button-primary: #007bff;
        --button-danger: #dc3545;
        --badge-high: #2196f3;
        --badge-low: #9c27b0;
    }

    [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --header-bg: #2d2d2d;
        --border-color: #404040;
        --table-bg: #2d2d2d;
        --row-hover: #404040;
        --modal-bg: #2d2d2d;
        --button-primary: #0d6efd;
        --button-danger: #dc3545;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    .content-title h1 {
        color: var(--text-color);
    }

    .results table {
        background-color: var(--table-bg);
        border-color: var(--border-color);
    }

    .results table th {
        background-color: var(--header-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .results table td {
        border-color: var(--border-color);
        color: var(--text-color);
    }

    .results table tr:hover {
        background-color: var(--row-hover);
    }

    #docModal > div,
    #addDocModal > div {
        background-color: var(--modal-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }

    .badge-high {
        background-color: var(--badge-high) !important;
        color: white !important;
    }

    .badge-low {
        background-color: var(--badge-low) !important;
        color: black !important;
    }

    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        background: var(--button-primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: all 0.3s;
    }

    .theme-toggle:hover {
        transform: scale(1.1);
    }

    .collections-filter {
        margin-bottom: 20px;
        padding: 15px;
        background: var(--header-bg);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 2px solid var(--button-primary);
        background: transparent;
        color: var(--button-primary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 5px;
    }

    .filter-btn.active,
    .filter-btn:hover {
        background: var(--button-primary);
        color: white;
    }

    .file-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: var(--table-bg);
        transition: all 0.3s;
    }

    .file-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .file-priority {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .priority-high {
        background: var(--badge-high);
        color: white;
    }

    .priority-low {
        background: var(--badge-low);
        color: black;
    }
</style>
{% endblock %}

{% block content_title %}
    <div style="position: relative;">
        <h1 style="margin-bottom: 10px;">{{ title }}</h1>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
            View and manage all generated PDF and Markdown files from code analysis.
            Use filters to find specific file types or analysis levels.
        </p>

        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Theme">
            üåô
        </button>
    </div>
{% endblock %}

{% block result_list %}
    {% if mongodb_error %}
        <div class="messagelist">
            <div class="error">{{ mongodb_error }}</div>
        </div>
    {% elif has_mongodb_data %}
        <!-- Collections Filter -->
        <div class="collections-filter">
            <h3 style="margin-top: 0; margin-bottom: 15px;">Collections Filter</h3>
            <div class="filter-buttons">
                <button type="button" class="filter-btn active" data-filter="all">All Generated</button>
                <button type="button" class="filter-btn" data-filter="pdf">PDF Files</button>
                <button type="button" class="filter-btn" data-filter="markdown">Markdown Files</button>
                <button type="button" class="filter-btn" data-filter="high">High Level</button>
                <button type="button" class="filter-btn" data-filter="low">Low Level</button>
            </div>
        </div>

        <form id="changelist-form" method="post">
            {% csrf_token %}
            <div class="results">
                <table id="result_list">
                    <thead>
                        <tr>
                            <th scope="col">
                                <input type="checkbox" id="action-toggle">
                            </th>
                            <th scope="col">Analysis Type</th>
                            <th scope="col">File Name</th>
                            <th scope="col">Content Preview</th>
                            <th scope="col">Generated Date</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in mongodb_data %}
                            <tr class="{% cycle 'row1' 'row2' %}" data-priority="{% if file.filename|upper|slice:':1' == 'H' or 'HIGH' in file.filename|upper %}high{% else %}low{% endif %}" data-type="{{ file.file_type }}" data-source="{{ file.source }}">
                                <td>
                                    <input type="checkbox" name="_selected_action" value="{{ file.id }}" class="action-select">
                                </td>
                                <td>
                                    {% if file.filename|upper|slice:':1' == 'H' or 'HIGH' in file.filename|upper %}
                                        <span class="badge badge-high">üîç High Level</span>
                                    {% else %}
                                        <span class="badge badge-low">‚öôÔ∏è Low Level</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ file.filename|default:"Unknown" }}</strong>
                                    {% if file.file_type == 'pdf' %}
                                        <br><small style="color: #666;">üìï PDF Document</small>
                                    {% elif file.file_type == 'markdown' %}
                                        <br><small style="color: #666;">üìù Markdown Document</small>
                                    {% else %}
                                        <br><small style="color: #666;">{{ file.file_type|default:"Document"|title }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.content or file.file_content %}
                                        {% with content=file.content|default:file.file_content %}
                                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                {% if content|length > 100 %}
                                                    {{ content|truncatechars:100|striptags }}
                                                {% else %}
                                                    {{ content|striptags }}
                                                {% endif %}
                                            </div>
                                            {% if content|length > 100 %}
                                                <br><a href="#" onclick="viewDocContent('{{ file.id }}', '{{ file.filename }}')"
                                                       style="color: #417690; text-decoration: none; font-size: 11px;">
                                                    üìñ Read More...
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span style="color: #999;">No content preview</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.created_at %}
                                        {{ file.created_at|date:"Y-m-d H:i" }}
                                    {% elif file.updated_at %}
                                        {{ file.updated_at|date:"Y-m-d H:i" }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.id %}
                                        <a href="#" onclick="viewDocContent('{{ file.id }}', '{{ file.filename }}')"
                                           style="color: #417690; text-decoration: none; margin-right: 10px;">
                                            üëÅÔ∏è View Content
                                        </a>
                                        {% if file.file_type == 'pdf' %}
                                            <a href="/api/export/download/{{ file.id }}/" target="_blank"
                                               style="color: #dc3545; text-decoration: none;">
                                                üì• Download PDF
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6">No generated files found in MongoDB.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Actions dropdown -->
            <div class="actions">
                <label>Action:
                    <select name="action" required>
                        <option value="" selected>---------</option>
                        <option value="delete_selected">Delete selected files</option>
                        <option value="add_new_item">Add new file</option>
                        <option value="mark_high_priority">Mark as High Priority</option>
                        <option value="mark_low_priority">Mark as Low Priority</option>
                    </select>
                </label>
                <button type="submit" class="button" title="Run the selected action" name="index" value="0">Go</button>
            </div>
        </form>

        <!-- Modal for viewing content -->
        <div id="docModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-height: 80%; overflow-y: auto;">
                <span onclick="closeDocModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2 id="docTitle">Document Content</h2>
                <pre id="docContent" style="white-space: pre-wrap; background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;"></pre>
            </div>
        </div>

        <!-- Modal for adding new documentation file -->
        <div id="addDocModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 60%; max-height: 80%; overflow-y: auto;">
                <span onclick="closeAddDocModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2>Add New Documentation File</h2>
                <form method="post" id="addDocForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_new_item">
                    
                    <div style="margin-bottom: 15px;">
                        <label for="filename" style="display: block; margin-bottom: 5px; font-weight: bold;">File Name:</label>
                        <input type="text" id="filename" name="filename" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                               placeholder="e.g., README.md, user-guide.txt">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="file_type" style="display: block; margin-bottom: 5px; font-weight: bold;">File Type:</label>
                        <select id="file_type" name="file_type"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="pdf">PDF Document</option>
                            <option value="markdown">Markdown Document</option>
                            <option value="text">Text File</option>
                            <option value="documentation">Documentation</option>
                            <option value="guide">Guide</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="priority" style="display: block; margin-bottom: 5px; font-weight: bold;">Priority Level:</label>
                        <select id="priority" name="priority"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="low">‚öôÔ∏è Low Level (Detailed)</option>
                            <option value="high">üîç High Level (Overview)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label for="category" style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
                        <input type="text" id="category" name="category"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                               placeholder="e.g., User Guide, API Documentation, Installation">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="content" style="display: block; margin-bottom: 5px; font-weight: bold;">Content:</label>
                        <textarea id="content" name="content" required rows="15"
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace;"
                                  placeholder="Enter your documentation content here..."></textarea>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="closeAddDocModal()" 
                                style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" 
                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                            Add Documentation File
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
        // Theme Management
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme from localStorage or default to light
            const currentTheme = localStorage.getItem('admin-theme') || 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton(currentTheme);

            // Theme toggle functionality
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('admin-theme', newTheme);
                    updateThemeButton(newTheme);
                });
            }

            function updateThemeButton(theme) {
                const button = document.getElementById('themeToggle');
                if (theme === 'dark') {
                    button.textContent = '‚òÄÔ∏è';
                    button.title = 'Switch to Light Theme';
                } else {
                    button.textContent = 'üåô';
                    button.title = 'Switch to Dark Theme';
                }
            }

            // Collections filtering
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter');
                    filterFiles(filter);
                });
            });

            function filterFiles(filter) {
                const rows = document.querySelectorAll('#result_list tbody tr');
                rows.forEach(row => {
                    const priority = row.getAttribute('data-priority');
                    const type = row.getAttribute('data-type');
                    const source = row.getAttribute('data-source');

                    let show = true;

                    switch(filter) {
                        case 'high':
                            show = priority === 'high';
                            break;
                        case 'low':
                            show = priority === 'low';
                            break;
                        case 'pdf':
                            show = type === 'pdf';
                            break;
                        case 'markdown':
                            show = type === 'markdown';
                            break;
                        case 'all':
                        default:
                            show = true;
                            break;
                    }

                    row.style.display = show ? '' : 'none';
                });
            }

            // Action handling
            const actionSelect = document.querySelector('select[name="action"]');
            const form = document.getElementById('changelist-form');

            if (actionSelect && form) {
                form.addEventListener('submit', function(e) {
                    const selectedAction = actionSelect.value;

                    if (selectedAction === 'add_new_item') {
                        e.preventDefault();
                        showAddDocModal();
                    } else if (selectedAction === 'delete_selected') {
                        const checkedBoxes = document.querySelectorAll('input[name="_selected_action"]:checked');
                        if (checkedBoxes.length === 0) {
                            e.preventDefault();
                            alert('Please select at least one item to delete.');
                        } else if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} selected item(s)?`)) {
                            e.preventDefault();
                        }
                    } else if (selectedAction === 'mark_high_priority' || selectedAction === 'mark_low_priority') {
                        const checkedBoxes = document.querySelectorAll('input[name="_selected_action"]:checked');
                        if (checkedBoxes.length === 0) {
                            e.preventDefault();
                            alert('Please select at least one item to update priority.');
                        } else {
                            // Here you would implement the priority update logic
                            e.preventDefault();
                            alert('Priority update feature - implement API endpoint to update file priorities');
                        }
                    }
                });
            }

            // Toggle all checkboxes
            const toggleAll = document.getElementById('action-toggle');
            const checkboxes = document.querySelectorAll('.action-select');

            if (toggleAll) {
                toggleAll.addEventListener('change', function() {
                    checkboxes.forEach(checkbox => {
                        if (checkbox.offsetParent !== null) { // Only visible checkboxes
                            checkbox.checked = this.checked;
                        }
                    });
                });
            }

            // Update toggle all when individual checkboxes change
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const visibleCheckboxes = document.querySelectorAll('.action-select:not([style*="display: none"])');
                    const checkedVisibleBoxes = document.querySelectorAll('.action-select:not([style*="display: none"]):checked');

                    toggleAll.checked = visibleCheckboxes.length > 0 && visibleCheckboxes.length === checkedVisibleBoxes.length;
                    toggleAll.indeterminate = checkedVisibleBoxes.length > 0 && checkedVisibleBoxes.length < visibleCheckboxes.length;
                });
            });
        });

        function viewDocContent(fileId, filename) {
            document.getElementById('docTitle').textContent = 'Content: ' + filename;
            document.getElementById('docContent').textContent = 'Loading...';
            document.getElementById('docModal').style.display = 'block';

            // Here you would typically make an AJAX call to fetch the content
            // For now, we'll show a placeholder
            setTimeout(() => {
                document.getElementById('docContent').textContent = 'Content viewing feature - implement API endpoint to fetch document content by ID: ' + fileId;
            }, 500);
        }

        function closeDocModal() {
            document.getElementById('docModal').style.display = 'none';
        }

        function showAddDocModal() {
            document.getElementById('addDocModal').style.display = 'block';
        }

        function closeAddDocModal() {
            document.getElementById('addDocModal').style.display = 'none';
            document.getElementById('addDocForm').reset();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const docModal = document.getElementById('docModal');
            const addDocModal = document.getElementById('addDocModal');

            if (event.target == docModal) {
                docModal.style.display = 'none';
            }
            if (event.target == addDocModal) {
                addDocModal.style.display = 'none';
            }
        }
        </script>
    {% else %}
        <div class="messagelist">
            <div class="info">No MongoDB data available.</div>
        </div>
    {% endif %}
{% endblock %}

{% block pagination %}
    {% if has_mongodb_data and mongodb_data|length > 0 %}
        <p class="paginator">
            {{ mongodb_data|length }} documentation file{{ mongodb_data|length|pluralize }} (showing first 100)
        </p>
    {% endif %}
{% endblock %}

{% block search %}{% endblock %}
{% block date_hierarchy %}{% endblock %}
{% block filters %}{% endblock %}