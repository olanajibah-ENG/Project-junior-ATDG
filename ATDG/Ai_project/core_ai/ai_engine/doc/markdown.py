"""
Markdown Documentation Generator

ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆÙ„ÙŠØ¯ ØªÙˆØ«ÙŠÙ‚ ÙÙ†ÙŠ Ø¨ØªÙ†Ø³ÙŠÙ‚ Markdown Ù†Ù‚ÙŠ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ HTML Ø£Ùˆ CSS.
Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙ‚Ø·.
"""

import logging
from core_ai.ai_engine.doc.doc_generator import DocumentationGenerator
import datetime
logger = logging.getLogger(__name__)


class MarkdownGenerator(DocumentationGenerator):
   def _format_output(self, content, data):
        """
        ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙƒÙ€ Markdown Ù†Ù‚ÙŠ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù†Ø§ØªØ¬ Ù…Ù† Ø§Ù„Ù€ Agents
        """
        content_str = str(content) if content else ""

        exp_type_display = "Technical Documentation"
        if data and data.get('explanation_type') == 'high_level':
            exp_type_display = "Executive Overview"
            
        created_at = datetime.datetime.now().strftime("%Y-%m-%d")
        
        filename = "UNKNOWN_MODULE"
        if data and data.get('filename'):
            filename = data.get('filename').upper()
        else:
            import re
            file_match = re.search(r'File:\s*([^\s\n]+)', content_str)
            if file_match:
                filename = file_match.group(1).upper()

        header = (
            f"# ðŸ“œ {filename}\n"
            f"> **STATUS:** âœ… VERIFIED | **DATE:** {created_at}\n"
            f"> **TYPE:** {exp_type_display}\n\n"
            f"---"
        )

        diagram = ""
        image_url = data.get('image_url', '') if data else ''
        if image_url:
            diagram = f"\n### ðŸ“Š Architecture Visualization\n![Class Diagram]({image_url})\n\n---\n"

        clean_content = re.sub(r'^File:.*?\n', '', content_str, flags=re.MULTILINE).strip()

        footer = (
            f"\n\n---\n"
            f"*Generated by **AutoTest & DocGen** | Technical Intelligence Unit*"
        )

        return f"{header}{diagram}\n\n{clean_content}{footer}"