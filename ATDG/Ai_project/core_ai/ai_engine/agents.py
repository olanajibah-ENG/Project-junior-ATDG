from .llm_client import GeminiClient

class BaseAgent:
    """Base class for all AI Agents"""
    def ask_ai(self, system_prompt, user_prompt):
        return GeminiClient.call_model(system_prompt, user_prompt)
class HighLevelAgent(BaseAgent):
    def process(self, code_content, class_name=None, analysis_summary=None, **kwargs):
        system = (
            "You are a Senior Software Architect. Provide a HIGH-LEVEL overview. "
            "IMPORTANT: Focus on WHAT the code does, not HOW. NO technical jargon.\n\n"
            "MANDATORY FORMATTING:\n"
            "1. Start with 'File: [Actual FileName]'.\n"
            "2. Use '##' for main sections.\n"
            "3. Use '---' separator BETWEEN every main section (Executive Summary, Purpose, etc).\n"
            "4. NO TABLES.\n\n"
            "4. Use '---' EXACTLY ONCE, only after the Executive Summary section.\n"
            "5. DO NOT use '---' anywhere else in the document.\n"
            "Structure:\n"
            "File: [FILENAME]\n\n"
            "## Executive Summary\n"
            "[2-3 sentences overview]\n\n"
            "--- \n\n"
            "## Purpose & Responsibility\n"
            "[Goal of this code]\n\n"
            "## Key Capabilities\n"
            "- Feature 1\n"
            "## Main Components\n"
            "- **Component**: Description\n"
        )
        
        
        context = ""
        if class_name: context += f"Class: {class_name}\n"
        if analysis_summary: context += f"Analysis Summary (Stats & Components):\n{analysis_summary}\n"  

        user = f"{context}Code:\n{code_content}\n\nProvide the high-level report."
        return self.ask_ai(system, user)

class LowLevelAgent(BaseAgent):
    def process(self, code_content, detailed_analysis=None, **kwargs):
        system = (
         "You are a Senior Technical Architect. Perform a DEEP LOGIC ANALYSIS.\n\n"
            "--- FILE NAMING RULE ---\n"
            "1. Your first line MUST be 'File: [GeneratedName].py'.\n"
            "2. Replace [GeneratedName] with a descriptive name based on the code's purpose (e.g., VehicleManager.py, AuthController.py, SystemEngine.py).\n\n"

            "STRICT FORMATTING RULES:\n"
            "1. Every Class MUST start with '## Class: Name'.\n"
            "2. Every Method MUST start with '### Method: name()'.\n"
            "3. IMPORTANT: Use double new lines (Enter twice) between every section and every method to avoid text clumping.\n"
            "4. Every Class section MUST end with the separator '---' on a new line by itself.\n"
            "5. NO TABLES. Use bold keys (e.g., **Purpose:**).\n"
            "6. Use Numbered lists for 'Logic Flow'.\n\n"
            "7. Do NOT use '---' inside the method description, only use it between classes."
            "Include ALL methods found in the class, including constructors and abstract methods."
            "Explain EVERY method and constructor listed in the context. Do not skip any element even if it seems simple."

            "Structure per Class:\n"
            "## Class: [ClassName]\n\n"
            "**Inheritance/Patterns:** [Mention what was found in context]\n"
            "**Purpose:** [Description]\n\n"
            "### Method: [name]\n\n"
            "**Description:** [Text]\n\n"
            "**Logic Flow:**\n"
            "1. Step One\n"
            "2. Step Two\n\n"
            "**Parameters:**\n"
            "- **p1**: description\n\n"
            "**Returns:** [Text]\n\n"
            "---\n"
        )
        
        user = f"Detailed Context (Relationships & Patterns):\n{detailed_analysis}\n\nCode:\n{code_content}\n\nAnalyze in detail."    
        return self.ask_ai(system, user)

class VerifierAgent(BaseAgent):
    def verify(self, code, explanation, force_verification=False, **kwargs):
        """
        Verify explanation accuracy with smart handling of large sizes to avoid breaking the process
        """
        code_size = len(str(code)) + len(str(explanation))
        
        if code_size > 50000 and not force_verification:
            print(f"Warning: Code size too large ({code_size}). Skipping AI Verification.")
            return explanation 

        system = (
            "You are a QA Lead and Technical Reviewer. Your task is to verify the accuracy of the technical explanation against the actual code.\n\n"
            "STRICT FORMATTING RULES:\n"
            "1. DO NOT change the structure of the explanation. Keep all tags like 'File:', '## Class:', '### Method:', and '---' exactly as they are.\n"
            "2. Correct ONLY the technical content (logic, parameter names, return values) if they are wrong.\n"
            "3. Ensure that the 'Logic Flow' numbers and 'Bold Keys' (e.g., **Purpose:**) are preserved.\n"
            "4. Return ONLY the corrected explanation text.\n"
            "5. NO meta-commentary (e.g., don't say 'I have corrected the text').\n"
            "6. Maintain the 'File: [FileName]' line at the very beginning.\n"
            "7. CRITICAL: Do NOT use '---' inside method descriptions. Only use it between classes or sections.\n\n"
            "Your goal is to ensure 100% technical accuracy while maintaining the EXACT visual formatting provided."
        )
        
        user = (
            f"Original Code:\n{code}\n\n"
            f"Explanation to Verify:\n{explanation}\n\n"
            "Please verify and correct the content above while keeping all formatting tags intact."
        )
        
        try:
            return self.ask_ai(system, user)
        except Exception as e:
            print(f"AI Verification failed: {e}")
            return explanation # Return to original explanation in case AI fails

    def verify_async(self, code, explanation, **kwargs):
        """Direct call version with forced verification enabled"""
        return self.verify(code, explanation, force_verification=True, **kwargs)