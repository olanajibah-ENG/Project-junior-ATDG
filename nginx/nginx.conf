# C:\مواد\Kamar_11_2025\nginx\nginx.conf
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    upstream upm_backend {
         server upm_django_app:8000; # اسم حاوية UPM_Project
    }

    upstream ai_backend {
        server ai_django_app:8000; # اسم حاوية Ai_Project
    }

    upstream notification_backend {
        server notification_django:8000; # اسم حاوية Notification_Service
    }

    # حل مشكلة ALLOWED_HOSTS - تعيين Host header صحيح
    map $http_host $backend_host {
        default $http_host;
        "~*^" $http_host;  # الحفاظ على Host الأصلي
    }

    server {
        listen 80; # استمع على المنفذ 80 على المضيف
        
        # توجيه طلبات UPM_Project
        location /api/upm/ {
            proxy_pass http://upm_backend;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
        }
        # توجيه طلبات Ai_Project
        location /api/analysis/ {
            # تمرير الطلب مع الحفاظ على المسار الكامل
            proxy_pass http://ai_backend;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # دعم جميع HTTP methods بشكل صريح
            proxy_method $request_method;

            # تمرير Body والHeaders بشكل صحيح
            proxy_pass_request_body on;
            proxy_pass_request_headers on;

            # دعم Content-Type للـ JSON
            proxy_set_header Content-Type $content_type;
            proxy_set_header Content-Length $content_length;

            # إعدادات إضافية للـ POST requests
            proxy_buffering off;
            proxy_request_buffering off;

            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # توجيه طلبات Notification Service
        location /api/notifications/ {
            proxy_pass http://notification_backend/;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # دعم جميع HTTP methods
            proxy_method $request_method;

            # تمرير Body والHeaders بشكل صحيح
            proxy_pass_request_body on;
            proxy_pass_request_headers on;

            # دعم Content-Type للـ JSON
            proxy_set_header Content-Type $content_type;
            proxy_set_header Content-Length $content_length;

            # إعدادات إضافية للـ POST requests
            proxy_buffering off;
            proxy_request_buffering off;

            # Timeout settings
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        
        # توجيه طلبات المصادقة (simplejwt) لـ UPM_Project
        location /api/token/ {
            proxy_pass http://upm_backend;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
        }
        # Admin للمشروع الرئيسي (UPM)
        location = /admin {
            return 302 /admin/;
        }
        location /admin/ {
            proxy_pass http://upm_backend/admin/;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
        }

        # Admin لمشروع الذكاء الاصطناعي (AI)
        location = /admin-ai {
            return 302 /admin-ai/;
        }
        location /admin-ai/ {
            proxy_pass http://ai_backend/admin/;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
        }

        # معالجة جميع طلبات admin-ai (بما في ذلك login وstatic files)
        location ~ ^/admin-ai/(.*)$ {
            proxy_pass http://ai_backend/admin/$1$is_args$args;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /admin-ai;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
            # إعادة كتابة redirects
            proxy_redirect ~^/admin/(.*)$ /admin-ai/$1;
            proxy_redirect ~^http://[^/]+/admin/(.*)$ /admin-ai/$1;
            # إعادة كتابة الكوكيز
            proxy_cookie_path /admin/ /admin-ai/;
            
            # إعادة كتابة المحتوى HTML
            sub_filter 'action="/admin/' 'action="/admin-ai/';
            sub_filter 'href="/admin/' 'href="/admin-ai/';
            sub_filter_once off;
            sub_filter_types text/html;
        }

        # معالجة صفحة login للـ admin (ذكي - يحدد الوجهة بناءً على السياق)
        location = /admin/login/ {
            # إذا كان الطلب يأتي من AI admin، اذهب إلى AI backend
            if ($http_referer ~ "/admin-ai/") {
                return 302 /admin-ai/login/;
            }
            # إلا ذلك، اذهب إلى UPM admin login
            proxy_pass http://upm_backend;
            proxy_set_header Host localhost;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # CSRF token forwarding
            proxy_set_header X-CSRFToken $http_x_csrftoken;
            # Cookie forwarding for CSRF
            proxy_pass_request_headers on;
        }                                   
        
        # توجيه طلبات Swagger لـ UPM_Project
        location /swagger-upm/ {
            rewrite ^/swagger-upm/(.*)$ /swagger/$1 break;
            proxy_pass http://upm_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # توجيه طلبات ReDoc لـ UPM_Project
        location /redoc-upm/ {
            rewrite ^/redoc-upm/(.*)$ /redoc/$1 break;
            proxy_pass http://upm_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        # توجيه طلبات Swagger لـ Ai_Project
        location /swagger-ai/ {
            rewrite ^/swagger-ai/(.*)$ /swagger/$1 break;
            proxy_pass http://ai_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # توجيه طلبات ReDoc لـ Ai_Project
        location /redoc-ai/ {
            rewrite ^/redoc-ai/(.*)$ /redoc/$1 break;
            proxy_pass http://ai_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location /static/upm/{
            alias /app/staticfiles/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location /static/ai/{
            alias /app/staticfiles/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

    
    

        # توجيه باقي الطلبات (مثلاً للـ Frontend إذا كان يخدم من هنا)
        location / {
            return 404 "API Gateway: No route for this path";
            # يمكنك هنا توجيهها إلى خدمة الواجهة الأمامية إذا كنت تخدمها من نفس الـ Gateway
            # proxy_pass http://frontend_service:3000/;
            # ...
        }
    }
}